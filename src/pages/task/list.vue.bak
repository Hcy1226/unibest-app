<route lang="json5">
{
  style: {
    navigationBarTitleText: 'ä»»åŠ¡åˆ—è¡¨',
    navigationStyle: 'custom',
  },
  // Bypass global auth check if it exists
  excludeLoginPath: true,
}
</route>

<template>
  <view class="bg-[#fafafa] min-h-screen text-slate-900 font-display pb-28">
    <!-- Header -->
    <!-- Header -->
    <!-- Header -->
    <view class="fixed top-0 left-0 w-full z-[999] bg-white/95 backdrop-blur-md border-b border-slate-100 px-4 py-3 flex items-center justify-between pt-[calc(env(safe-area-inset-top)+44px)]">
      <view class="flex items-center gap-3">
         <view>
           <text class="text-xs font-medium text-slate-500 block">å·¥ä½œå?/text>
           <text class="text-base font-bold text-slate-900 block leading-tight">{{ pageTitle }}</text>
         </view>
      </view>
      <button v-if="isSupervisor" class="relative p-2 rounded-full hover:bg-slate-100 transition-colors bg-white border-none">
        <view class="i-material-symbols-filter-list text-slate-600 text-2xl" />
      </button>
    </view>
    <!-- Spacer -->
    <view class="w-full h-[220rpx] pt-safe"></view>

    <view class="flex flex-col gap-6 p-4">
      <!-- Stats -->
      <view v-if="isSupervisor">
         <view class="grid grid-cols-3 gap-3">
            <view class="p-3 rounded-xl bg-orange-50 border border-orange-100 flex flex-col items-center gap-1 shadow-sm">
               <text class="text-xs font-medium text-orange-600">å¾…æŒ‡æ´?/text>
               <text class="text-2xl font-bold text-orange-700">{{ pendingCount }}</text>
            </view>
            <view class="p-3 rounded-xl bg-blue-50 border border-blue-100 flex flex-col items-center gap-1 shadow-sm">
               <text class="text-xs font-medium text-blue-600">è¿›è¡Œä¸?/text>
               <text class="text-2xl font-bold text-blue-700">{{ inProgressCount }}</text>
            </view>
            <view class="p-3 rounded-xl bg-white border border-slate-100 flex flex-col items-center gap-1 shadow-sm">
               <text class="text-xs font-medium text-slate-500">å·²å®Œæˆ?/text>
               <text class="text-2xl font-bold text-slate-700">{{ completedCount }}</text>
            </view>
         </view>
      </view>

      <!-- Exception Overview -->
      <view class="flex flex-col gap-3" v-if="isSupervisor">
         <view class="flex items-center justify-between">
            <view class="text-sm font-bold text-slate-900 flex items-center gap-1.5">
               <view class="i-material-symbols-error-outline text-red-500 text-[18px]" />
               <text>å¼‚å¸¸æ¦‚è§ˆ</text>
            </view>
            <view class="text-xs font-medium text-slate-400 flex items-center gap-0.5" @click="navigateTo('/pages/task/exception')">
               <text>å¼‚å¸¸ç»Ÿè®¡</text>
               <view class="i-material-symbols-chevron-right text-[14px]" />
            </view>
         </view>
         
         <view class="flex gap-3 overflow-x-auto no-scrollbar -mx-4 px-4">
            <!-- Card 1 -->
            <view class="min-w-[160px] flex-1 p-3 rounded-xl bg-red-50 border border-red-100 flex flex-col gap-1 relative overflow-hidden">
               <view class="flex items-center justify-between z-10">
                  <text class="text-xs font-medium text-red-600">è¶…æ—¶ä»»åŠ¡</text>
                  <view class="i-material-symbols-schedule text-red-200 text-[20px]" />
               </view>
               <view class="flex items-end gap-1 z-10">
                  <text class="text-2xl font-bold text-red-700">{{ overdueCount }}</text>
                  <text class="text-[10px] text-red-500/60 mb-1">é¡¹å·²é€¾æœŸ</text>
               </view>
               <view class="absolute -right-2 -bottom-2 opacity-5 text-red-900">
                  <view class="i-material-symbols-warning text-[64px]" />
               </view>
            </view>
            <!-- Card 2 -->
             <view class="min-w-[160px] flex-1 p-3 rounded-xl bg-rose-50 border border-rose-100 flex flex-col gap-1 relative overflow-hidden">
               <view class="flex items-center justify-between z-10">
                  <text class="text-xs font-medium text-rose-600">è¢«é©³å›æ•°</text>
                  <view class="i-material-symbols-assignment-return text-rose-200 text-[20px]" />
               </view>
               <view class="flex items-end gap-1 z-10">
                  <text class="text-2xl font-bold text-rose-700">{{ rejectedCount }}</text>
                  <text class="text-[10px] text-rose-500/60 mb-1">æ¬¡å¾…ä¿®æ­£</text>
               </view>
               <view class="absolute -right-2 -bottom-2 opacity-5 text-rose-900">
                  <view class="i-material-symbols-cancel text-[64px]" />
               </view>
            </view>
         </view>
      </view>

      <!-- Search & Filters -->
      <view class="flex flex-col gap-4" v-if="isSupervisor">
         <view class="relative">
             <view class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                 <view class="i-material-symbols-search text-[20px]" />
             </view>
             <input class="w-full pl-10 pr-4 py-3 rounded-xl bg-white border border-slate-200 text-sm focus:border-[#00b2b2] placeholder-slate-400" placeholder="æœç´¢ä»»åŠ¡åç§°ã€ç¼–å·æˆ–è´Ÿè´£äº?.." type="text" />
         </view>
         <view class="flex items-center gap-2 overflow-x-auto no-scrollbar pb-1">
             <button class="px-4 py-1.5 rounded-full bg-[#00b2b2] text-white text-sm font-medium whitespace-nowrap shadow-sm shadow-[#00b2b2]/20 border-none">å…¨éƒ¨ä»»åŠ¡</button>
             <button class="px-4 py-1.5 rounded-full bg-white border border-slate-200 text-slate-600 text-sm font-medium whitespace-nowrap hover:bg-slate-50">é«˜ä¼˜å…ˆçº§ (2)</button>
             <button class="px-4 py-1.5 rounded-full bg-white border border-slate-200 text-slate-600 text-sm font-medium whitespace-nowrap hover:bg-slate-50">å¾…æŒ‡æ´?(3)</button>
             <button class="px-4 py-1.5 rounded-full bg-white border border-slate-200 text-slate-600 text-sm font-medium whitespace-nowrap hover:bg-slate-50">å¾…éªŒæ”?(1)</button>
         </view>
      </view>

      <!-- Task List -->
      <view class="flex flex-col gap-3">
         <view class="flex items-center justify-between mb-1">
             <text class="text-lg font-bold text-slate-900">{{ isSupervisor ? 'ä»»åŠ¡åˆ—è¡¨' : 'å†å²è®°å½•' }}</text>
             <view class="text-xs font-medium text-[#00b2b2] flex items-center gap-0.5">
                 <view class="i-material-symbols-filter-list text-[16px]" />
                 <text>ç­›é€?/text>
             </view>
         </view>


         <!-- Dynamic Task List -->
         <view v-if="loading" class="flex justify-center py-10">
            <text class="text-sm text-slate-400">åŠ è½½ä¸?..</text>
         </view>
         
         <view v-else-if="tasks.length === 0" class="flex justify-center py-10">
            <text class="text-sm text-slate-400">æš‚æ— ä»»åŠ¡</text>
         </view>
         
         <view v-else v-for="task in tasks" :key="task.id" 
               class="flex flex-col p-4 rounded-2xl bg-white border border-slate-100 shadow-sm gap-4 relative overflow-hidden" 
               @click="showTaskDetail(task)">
             <!-- Priority Color Bar -->
             <view class="absolute top-0 left-0 w-1 h-full" 
                   :class="{
                     'bg-red-500': task.priority === 'emergency',
                     'bg-orange-400': task.priority === 'high',
                     'bg-blue-500': task.priority === 'normal',
                     'bg-slate-400': task.priority === 'low'
                   }"></view>
             
             <view class="flex items-start justify-between">
                 <view class="flex items-start gap-3">
                     <!-- Task Icon -->
                     <view class="size-11 rounded-lg flex items-center justify-center shrink-0"
                           :class="{
                             'bg-red-50 text-red-500': task.priority === 'emergency',
                             'bg-orange-50 text-orange-500': task.priority === 'high',
                             'bg-blue-50 text-blue-500': task.priority === 'normal',
                             'bg-slate-50 text-slate-500': task.priority === 'low'
                           }">
                         <view class="text-xl" :class="{
                           'i-material-symbols-warning': task.priority === 'emergency',
                           'i-material-symbols-engineering': task.type === 'maintenance',
                           'i-material-symbols-cleaning-services': task.type === 'cleaning',
                           'i-material-symbols-security': task.type === 'security',
                           'i-material-symbols-assignment-turned-in': task.type === 'inspection'
                         }" />
                     </view>
                     
                     <view>
                         <view class="flex items-center gap-2 flex-wrap">
                             <text class="font-bold text-slate-900">{{ task.title }}</text>
                             <!-- Priority Badge -->
                             <text class="px-1.5 py-0.5 rounded text-[10px] font-bold"
                                   :class="{
                                     'bg-red-100 text-red-600': task.priority === 'emergency',
                                     'bg-orange-100 text-orange-700': task.priority === 'high',
                                     'bg-blue-100 text-blue-600': task.priority === 'normal',
                                     'bg-slate-100 text-slate-600': task.priority === 'low'
                                   }">
                               {{ taskPriorityMap[task.priority]?.text || task.priority }}
                             </text>
                             <!-- Status Badge -->
                             <text class="px-1.5 py-0.5 rounded text-[10px] font-bold"
                                   :class="{
                                     'bg-orange-100 text-orange-700': task.status === 'pending',
                                     'bg-blue-100 text-blue-600': task.status === 'assigned',
                                     'bg-cyan-100 text-cyan-700': task.status === 'in_progress',
                                     'bg-green-100 text-green-700': task.status === 'completed'
                                   }">
                               {{ taskStatusMap[task.status] || task.status }}
                             </text>
                         </view>
                         <text class="text-xs text-slate-500 mt-1 line-clamp-1 block">{{ task.description || 'æ— æè¿? }}</text>
                     </view>
                 </view>
             </view>
             
             <view class="flex items-center justify-between pt-3 border-t border-slate-50">
                 <!-- Assignee Info -->
                     <text class="text-[10px] text-slate-400 uppercase tracking-wider font-bold mb-1">è´Ÿè´£äº?/text>
                     <text v-if="task.status === 'pending' && !task.assigneeId && !task.assignee" class="text-xs font-medium text-slate-400 italic">å¾…æŒ‡æ´?/text>
                     <text v-else-if="task.assignee" class="text-xs font-medium text-slate-600">{{ task.assignee.name }}</text>
                     <text v-else-if="task.assigneeId" class="text-xs font-medium text-slate-600">{{ getAssigneeName(task.assigneeId) }}</text>
                     <text v-else class="text-xs font-medium text-slate-400">æœªæŒ‡æ´?/text>

                 
                 <!-- Action Buttons -->
                 <view class="flex gap-2">
                     <!-- Pending tasks: show assign button -->
                     <template v-if="task.status === 'pending'">
                         <button class="flex items-center justify-center px-3 py-1.5 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 text-xs font-semibold bg-white" 
                                 @click.stop="navigateTo('/pages/task/split')">æ‹†åˆ†ä»»åŠ¡</button>
                         <button class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-[#00b2b2] text-white shadow-sm hover:bg-[#00b2b2]/90 text-xs font-semibold border-none"
                                 @click.stop="assignTask(task)">
                             <view class="i-material-symbols-person-add text-[16px]" />
                             <text>æŒ‡æ´¾</text>
                         </button>
                     </template>
                     
                     <!-- In Progress tasks: show progress button -->
                     <template v-else-if="task.status === 'in_progress'">
                         <button class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg border border-[#00b2b2] text-[#00b2b2] hover:bg-[#00b2b2]/5 transition-colors text-xs font-semibold bg-white">
                             æŸ¥çœ‹è¿›åº¦
                         </button>
                     </template>
                     
                     <!-- Completed tasks: show verify button -->
                     <template v-else-if="task.status === 'completed'">
                         <button class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-600 text-white shadow-sm hover:bg-green-700 transition-colors text-xs font-semibold border-none">
                             <view class="i-material-symbols-check-circle text-[16px]" />
                             <text>éªŒæ”¶é€šè¿‡</text>
                         </button>
                     </template>
                 </view>
             </view>
         </view>
      </view>
    </view>
    <CustomTabBar />
  </view>
</template>

<script lang="ts" setup>
import { ref, computed } from 'vue'
import { onShow } from '@dcloudio/uni-app'
import { getTaskList } from '@/api/task'
import type { ITask } from '@/api/types/task'
import { getUsers, type User } from '@/api/user'
import { useUserStore } from '@/store/user'

const tasks = ref<ITask[]>([])
const users = ref<User[]>([])
const loading = ref(false)
const isSupervisor = ref(true)
const pageTitle = ref('ä»»åŠ¡ç®¡ç†')

// Computed statistics
const pendingCount = computed(() => tasks.value.filter(t => t.status === 'pending').length)
const inProgressCount = computed(() => tasks.value.filter(t => t.status === 'in_progress').length)
const completedCount = computed(() => tasks.value.filter(t => t.status === 'completed').length)
const overdueCount = computed(() => {
  const now = new Date()
  return tasks.value.filter(t => {
    if (!t.deadline || t.status === 'completed') return false
    return new Date(t.deadline) < now
  }).length
})
const rejectedCount = computed(() => tasks.value.filter(t => t.status === 'rejected').length)

// Task type mapping
const taskTypeMap: Record<string, string> = {
  maintenance: 'è®¾å¤‡æ£€ä¿?,
  cleaning: 'æ¸…æ´å«ç”Ÿ',
  security: 'å®‰å…¨å·¡æ£€',
  inspection: 'ä¾‹è¡Œæ£€æŸ?
}

const taskPriorityMap: Record<string, { text: string, color: string }> = {
  low: { text: 'ä½?, color: 'slate' },
  normal: { text: 'ä¸?, color: 'blue' },
  high: { text: 'é«?, color: 'orange' },
  emergency: { text: 'ç´§æ€?, color: 'red' }
}

const taskStatusMap: Record<string, string> = {
  pending: 'å¾…æŒ‡æ´?,
  assigned: 'å¾…å¼€å§?,
  in_progress: 'è¿›è¡Œä¸?,
  completed: 'å·²å®Œæˆ?,
  verified: 'å·²éªŒæ”?,
  rejected: 'å·²é©³å›?
}

const fetchTasks = async () => {
  loading.value = true
  try {
    console.log('[Task List] Fetching tasks...')
    const data = await getTaskList()
    tasks.value = data
    console.log('[Task List] Tasks received:', data.length)
    console.log('[Task List] Stats:', {
      pending: pendingCount.value,
      in_progress: inProgressCount.value,
      completed: completedCount.value,
      overdue: overdueCount.value,
      rejected: rejectedCount.value
    })
  } catch (error) {
    console.error('[Task List] Failed to fetch tasks:', error)
    uni.showToast({ title: 'åŠ è½½ä»»åŠ¡å¤±è´¥', icon: 'error' })
  } finally {
    loading.value = false
  }
}

// Fetch users for assignee name lookup
const fetchUsers = async () => {
  try {
    const data = await getUsers()
    users.value = data
    console.log('[Task List] Users loaded:', data.length)
  } catch (error) {
    console.error('[Task List] Failed to fetch users:', error)
  }
}

// Get assignee name by ID
const getAssigneeName = (assigneeId: number) => {
  const user = users.value.find(u => u.id === assigneeId)
  return user ? user.name : 'æœªçŸ¥ç”¨æˆ·'
}

// Show task detail
const showTaskDetail = (task: ITask) => {
  console.log('[Task List] Show detail for task:', task.id)
  navigateTo(`/pages/task/detail?taskId=${task.id}`)
}

// Assign task
const selectedTaskForAssignment = ref<ITask | null>(null)
const showEmployeeSelector = ref(false)

// Get employees (non-admin, non-supervisor users)
const employeeUsers = computed(() => {
  const userStore = useUserStore()
  const currentUserId = userStore.userInfo?.id
  return users.value.filter(u => 
    u.role !== 'admin' && 
    u.role !== 'supervisor' &&
    u.id !== currentUserId
  )
})

const assignTask = (task: ITask) => {
  console.log('[Task List] Opening assignment for task:', task.id)
  selectedTaskForAssignment.value = task
  showEmployeeSelector.value = true
}

const assignToEmployee = async (employeeId: number) => {
  if (!selectedTaskForAssignment.value) return
  
  try {
    uni.showLoading({ title: 'æŒ‡æ´¾ä¸?..' })
    
    console.log('[Task List] Assigning task:', selectedTaskForAssignment.value.id, 'to employee:', employeeId)
    
    // Import updateTask from API
    const { updateTask } = await import('@/api/task')
    
    // Call API to update task
    const updatedTask = await updateTask(selectedTaskForAssignment.value.id, {
      assigneeId: employeeId,
      status: 'in_progress' // Change status to in_progress
    })
    
    console.log('[Task List] Assignment successful:', updatedTask)
    
    // Close selector
    showEmployeeSelector.value = false
    selectedTaskForAssignment.value = null
    
    uni.hideLoading()
    uni.showToast({ 
      title: 'æŒ‡æ´¾æˆåŠŸ', 
      icon: 'success',
      duration: 2000
    })
    
    // Refresh task list
    await fetchTasks()
    
  } catch (error) {
    console.error('[Task List] Assignment failed:', error)
    uni.hideLoading()
    uni.showToast({ 
      title: 'æŒ‡æ´¾å¤±è´¥', 
      icon: 'error',
      duration: 2000
    })
  }
}

const cancelAssignment = () => {
  showEmployeeSelector.value = false
  selectedTaskForAssignment.value = null
}

const navigateTo = (url: string) => {
  uni.navigateTo({ url })
}

onShow(async () => {
  console.log('Task List Page: onShow Triggered')
  
  try {
    const userStore = useUserStore()
    const role = userStore.userInfo?.role
    // Explicitly check for employee role
    if (role === 'employee') {
      isSupervisor.value = false
      pageTitle.value = 'æˆ‘çš„ä»»åŠ¡å†å²'
    } else {
      // Default to supervisor for admin/supervisor/undefined (dev safety)
      isSupervisor.value = true
      pageTitle.value = 'ä»»åŠ¡ç®¡ç†'
    }
    
    // Fetch tasks and users from API
    await Promise.all([fetchTasks(), fetchUsers()])
  } catch (error) {
    console.error('Error in Task List onShow:', error)
  }
})
</script>

<style>
.line-clamp-1 {
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 1;
  line-clamp: 1;
  overflow: hidden;
}
</style>
